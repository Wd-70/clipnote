"use client";

import { useState, useEffect, useCallback, useRef, useMemo } from "react";
import { motion } from "framer-motion";
import { SongData } from "@/types";
import {
  MusicalNoteIcon,
  PlayIcon,
  PauseIcon,
  XMarkIcon,
  VideoCameraIcon,
  MagnifyingGlassIcon,
  ArrowTopRightOnSquareIcon,
  ListBulletIcon,
  PencilIcon,
  ComputerDesktopIcon,
  DocumentDuplicateIcon,
} from "@heroicons/react/24/outline";
import { HeartIcon } from "@heroicons/react/24/solid";
import YouTube from "react-youtube";
import { useLike } from "@/hooks/useLikes";
import { useSongPlaylists } from "@/hooks/useGlobalPlaylists";
import PlaylistContextMenu from "./PlaylistContextMenu";
import LiveClipManager from "./LiveClipManager";
import LiveClipEditor from "./LiveClipEditor";
import SongEditForm from "./SongEditForm";
import SongDetailModal from "./SongDetailModal";
import { useSession } from "next-auth/react";
import { useToast } from "./Toast";
import { useConfirm } from "./ConfirmDialog";

// YouTube í”Œë ˆì´ì–´ íƒ€ì… ì •ì˜
interface YouTubePlayer {
  playVideo(): void;
  pauseVideo(): void;
  getPlayerState(): number;
}

interface SongCardProps {
  song: SongData;
  onPlay?: (song: SongData) => void;
  showNumber?: boolean;
  number?: number;
  onDialogStateChange?: (isOpen: boolean) => void;
}

export default function SongCard({
  song,
  showNumber = false,
  number,
  onDialogStateChange,
}: SongCardProps) {
  const { data: session } = useSession();
  const { liked, isLoading: likeLoading, toggleLike } = useLike(song.id);
  const { playlists: songPlaylists } = useSongPlaylists(song.id);
  const [isExpanded, setIsExpanded] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentTab, setCurrentTab] = useState<"lyrics" | "mr" | "videos">(
    "lyrics"
  );
  const [youtubePlayer, setYoutubePlayer] = useState<YouTubePlayer | null>(
    null
  );
  const [isXLScreen, setIsXLScreen] = useState(false);
  const [playerPosition, setPlayerPosition] = useState({
    top: 0,
    left: 0,
    width: 0,
    height: 0,
  });
  const [liveClipPosition, setLiveClipPosition] = useState({
    top: 0,
    left: 0,
    width: 0,
    height: 0,
  });
  const [showPlaylistMenu, setShowPlaylistMenu] = useState(false);
  const [menuPosition, setMenuPosition] = useState({ x: 0, y: 0 });
  const [isMobileScreen, setIsMobileScreen] = useState(false);

  // í¸ì§‘ ëª¨ë“œ ìƒíƒœ
  const [isEditMode, setIsEditMode] = useState(false);
  // ë¼ì´ë¸Œ í´ë¦½ ë°ì´í„° ìƒíƒœ (LiveClipManagerì™€ LiveClipEditor ê³µìœ )
  const [songVideos, setSongVideos] = useState<any[]>([]);
  const [videosLoading, setVideosLoading] = useState(false);

  // í† ìŠ¤íŠ¸ í›…
  const { showSuccess, showError, showInfo } = useToast();
  const confirm = useConfirm();
  const [videosLoaded, setVideosLoaded] = useState(false); // í•œ ë²ˆì´ë¼ë„ ë¡œë“œ ì‹œë„í–ˆëŠ”ì§€ ì¶”ì 

  // ê°€ì‚¬ ì „ìš© ìƒíƒœ (ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ë¶„ë¦¬)
  const [lyricsText, setLyricsText] = useState(song.lyrics || "");

  // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
  const isAdmin = session?.user?.isAdmin || false;

  // OBS ìƒíƒœ ê´€ë¦¬
  const [obsActive, setObsActive] = useState(false);
  const [obsLoading, setObsLoading] = useState(false);

  // Player position ê³„ì‚° ìµœì í™”
  const optimizedPlayerStyle = useMemo(() => {
    const shouldShow =
      (isXLScreen && (currentTab === "mr" || currentTab === "lyrics")) ||
      (!isXLScreen && currentTab === "mr");

    return {
      position: "fixed" as const,
      top: shouldShow ? playerPosition.top : -9999,
      left: shouldShow ? playerPosition.left : -9999,
      width: `${playerPosition.width || 0}px`,
      height: `${playerPosition.height || 0}px`,
      maxWidth: `${playerPosition.width || 0}px`,
      maxHeight: `${playerPosition.height || 0}px`,
      minWidth: 0,
      minHeight: 0,
      pointerEvents: "auto" as const,
      zIndex: 50,
      overflow: "hidden" as const,
      boxSizing: "border-box" as const,
    };
  }, [isXLScreen, currentTab, playerPosition]);

  // LiveClip position ê³„ì‚° ìµœì í™”
  const optimizedLiveClipStyle = useMemo(() => {
    const shouldShow = currentTab === "videos";

    return {
      position: "fixed" as const,
      top: shouldShow ? liveClipPosition.top : -9999,
      left: shouldShow ? liveClipPosition.left : -9999,
      width: `${liveClipPosition.width || 0}px`,
      height: `${liveClipPosition.height || 0}px`,
      maxWidth: `${liveClipPosition.width || 0}px`,
      maxHeight: `${liveClipPosition.height || 0}px`,
      minWidth: 0,
      minHeight: 0,
      pointerEvents: "auto" as const,
      zIndex: 50,
      overflow: "hidden" as const,
      boxSizing: "border-box" as const,
    };
  }, [isXLScreen, currentTab, liveClipPosition]);


  // ë¼ì´ë¸Œ í´ë¦½ ë°ì´í„° ë¡œë“œ
  const loadSongVideos = useCallback(async () => {
    setVideosLoading(true);
    try {
      const response = await fetch(`/api/songs/${song.id}/videos`);
      if (response.ok) {
        const data = await response.json();
        setSongVideos(data.videos || []);
        setVideosLoaded(true); // ì„±ê³µì ìœ¼ë¡œ ë¡œë“œí–ˆìŒì„ í‘œì‹œ
      } else {
        console.error("ë¼ì´ë¸Œ í´ë¦½ ë¡œë”© ì‹¤íŒ¨");
        setVideosLoaded(true); // ì‹¤íŒ¨í•´ë„ ì‹œë„í–ˆìŒì„ í‘œì‹œ
      }
    } catch (error) {
      console.error("ë¼ì´ë¸Œ í´ë¦½ ë¡œë”© ì˜¤ë¥˜:", error);
      setVideosLoaded(true); // ì—ëŸ¬ê°€ ë‚˜ë„ ì‹œë„í–ˆìŒì„ í‘œì‹œ
    } finally {
      setVideosLoading(false);
    }
  }, [song.id]); // song.idê°€ ë³€ê²½ë  ë•Œë§Œ í•¨ìˆ˜ ì¬ìƒì„±

  // ê³¡ì´ ë°”ë€” ë•Œ ë¼ì´ë¸Œ í´ë¦½ ìƒíƒœ ì´ˆê¸°í™”
  useEffect(() => {
    setSongVideos([]);
    setVideosLoaded(false);
    setVideosLoading(false);
  }, [song.id]);

  // ë¼ì´ë¸Œ í´ë¦½ ë°ì´í„° ë¡œë“œ (videos íƒ­ì„ ì²˜ìŒ ì—´ ë•Œë§Œ)
  useEffect(() => {
    if (
      isExpanded &&
      currentTab === "videos" &&
      !videosLoaded &&
      !videosLoading
    ) {
      loadSongVideos();
    }
  }, [isExpanded, currentTab, videosLoaded, videosLoading, loadSongVideos]);

  // debounced ê°€ì‚¬ ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬ (ì„±ëŠ¥ ìµœì í™”)
  const handleLyricsChange = useCallback((newLyrics: string) => {
    // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (ì‚¬ìš©ì ì…ë ¥ ë°˜ì‘ì„± ìœ ì§€)
    setLyricsText(newLyrics);
  }, []);

  // songì´ ë³€ê²½ë  ë•Œ lyricsText ì´ˆê¸°í™”
  useEffect(() => {
    setLyricsText(song.lyrics || "");
  }, [song.lyrics]);


  // XL í™”ë©´ì—ì„œëŠ” MR íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •
  useEffect(() => {
    const updateDefaultTab = () => {
      const isXL = window.innerWidth >= 1280;
      if (isExpanded && isXL && currentTab === "lyrics") {
        // XL í™”ë©´ì—ì„œ ê°€ì‚¬ íƒ­ì´ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ MR íƒ­ìœ¼ë¡œ ë³€ê²½
        setCurrentTab("mr");
      }
    };

    // ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì—´ë¦´ ë•Œ ì‹¤í–‰
    if (isExpanded) {
      updateDefaultTab();
      // í™”ë©´ í¬ê¸° ë³€ê²½ ê°ì§€
      window.addEventListener("resize", updateDefaultTab);
    }

    return () => {
      window.removeEventListener("resize", updateDefaultTab);
    };
  }, [isExpanded, currentTab]);

  // í¸ì§‘ ëª¨ë“œ í† ê¸€
  const toggleEditMode = () => {
    setIsEditMode(!isEditMode);
  };

  // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸° ê³µí†µ í•¨ìˆ˜
  const handleCloseDialog = useCallback(() => {
    setIsExpanded(false);
    setIsEditMode(false);
    setCurrentTab("lyrics");
    
    // ëª¨ë“  í”Œë ˆì´ì–´ ìƒíƒœ ì´ˆê¸°í™”
    setYoutubePlayer(null);
    setIsPlaying(false);
    
    // OBSê°€ ON ìƒíƒœì¸ ê²½ìš°ì—ë§Œ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ì„ ë•Œ OFF
    if (obsActive && session?.user?.userId) {
      // ì¦‰ì‹œ UI ìƒíƒœ ì—…ë°ì´íŠ¸
      setObsActive(false);
      // API ìš”ì²­ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬ (ì‘ë‹µ ëŒ€ê¸° ì•ˆí•¨)
      fetch("/api/obs/delete", { method: "DELETE" }).catch((error) => {
        console.error("OBS ìƒíƒœ ì •ë¦¬ ì˜¤ë¥˜:", error);
      });
      console.log("ë‹¤ì´ì–¼ë¡œê·¸ ë‹«í˜ìœ¼ë¡œ ì¸í•œ OBS ìƒíƒœ OFF");
    }
  }, [obsActive, session?.user?.userId]);

  // ESC í‚¤ í•¸ë“¤ëŸ¬
  const handleEscapeKey = useCallback(async () => {
    if (isEditMode) {
      // ìˆ˜ì • ëª¨ë“œì—ì„œ ESC: ì¼ë°˜ ëª¨ë“œë¡œ
      setIsEditMode(false);
    } else {
      // ì¼ë°˜ ëª¨ë“œì—ì„œ ESC: ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
      handleCloseDialog();
    }
  }, [isEditMode, handleCloseDialog]);

  // ESC í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === "Escape") {
        event.preventDefault();
        handleEscapeKey();
      }
    };

    if (isExpanded) {
      document.addEventListener("keydown", handleKeyDown);
    }

    return () => {
      document.removeEventListener("keydown", handleKeyDown);
    };
  }, [isExpanded, handleEscapeKey]);

  // SongEditFormìš© ì €ì¥ í•¸ë“¤ëŸ¬
  const handleSaveEdit = (updatedSong: SongData) => {
    // ê³¡ ë°ì´í„° ì—…ë°ì´íŠ¸
    Object.assign(song, updatedSong);
    setIsEditMode(false);
  };

  // í¸ì§‘ ì·¨ì†Œ
  const cancelEdit = () => {
    setIsEditMode(false);
  };

  // OBS í† ê¸€ í•¨ìˆ˜
  const toggleOBS = async () => {
    if (!session?.user?.userId) {
      showError("ë¡œê·¸ì¸ í•„ìš”", "OBS ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    if (obsLoading) {
      console.log("OBS ìš”ì²­ ì´ë¯¸ ì§„í–‰ ì¤‘...");
      return; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    }

    setObsLoading(true);
    try {
      if (obsActive) {
        // OBS OFF - ìƒíƒœ ì‚­ì œ
        const response = await fetch("/api/obs/delete", {
          method: "DELETE",
        });

        if (response.ok) {
          setObsActive(false);
          console.log("OBS ìƒíƒœ OFF");
        } else {
          // ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì„œë²„ ì¬ì‹œì‘ìœ¼ë¡œ ìƒíƒœê°€ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŒ
          console.log("OBS OFF ì‘ë‹µ (ê°œë°œí™˜ê²½ì—ì„œëŠ” ì •ìƒ)");
          setObsActive(false);
        }
      } else {
        // OBS ON - ìƒíƒœ ìƒì„±
        const currentSong = {
          title: song.titleAlias || song.title,
          artist: song.artistAlias || song.artist,
        };

        const response = await fetch("/api/obs/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ currentSong }),
        });

        const result = await response.json();

        if (result.success) {
          setObsActive(true);
          console.log(`OBS ìƒíƒœ ON: ${result.obsUrl}`);
        } else if (response.status === 409) {
          // ê¸°ì¡´ OBSê°€ í™œì„±í™”ë˜ì–´ ìˆì§€ë§Œ UIìƒ ON ìƒíƒœë¡œ í‘œì‹œ (ìˆ˜ë™ìœ¼ë¡œ ëŒ ìˆ˜ ìˆë„ë¡)
          setObsActive(true);
          showError("OBS ì´ë¯¸ í™œì„±í™”ë¨", "ë‹¤ë¥¸ ê³¡ì˜ OBSê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ë„ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
        } else {
          showError("OBS ì˜¤ë¥˜", result.error || "OBS ì¼œê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }
    } catch (error) {
      console.error("OBS í† ê¸€ ì˜¤ë¥˜:", error);
      showError("OBS ì˜¤ë¥˜", "OBS ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
      setObsLoading(false);
    }
  };

  // OBS ë§í¬ ë³µì‚¬ í•¨ìˆ˜
  const copyOBSLink = async () => {
    if (!session?.user?.userId) {
      showError(
        "ë¡œê·¸ì¸ í•„ìš”",
        "OBS ë§í¬ ë³µì‚¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
      );
      return;
    }

    const obsUrl = `${window.location.origin}/obs/overlay/${session.user.userId}`;

    try {
      await navigator.clipboard.writeText(obsUrl);
      showSuccess("ë³µì‚¬ ì™„ë£Œ", "OBS ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
    } catch (error) {
      console.error("í´ë¦½ë³´ë“œ ë³µì‚¬ ì˜¤ë¥˜:", error);
      // ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì„ íƒ
      const textArea = document.createElement("textarea");
      textArea.value = obsUrl;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand("copy");
      document.body.removeChild(textArea);
      showSuccess("ë³µì‚¬ ì™„ë£Œ", "OBS ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
  };

  // íƒœê·¸ ë³€ê²½ í•¸ë“¤ëŸ¬

  const languageColors = {
    Korean: "bg-blue-500",
    English: "bg-purple-500",
    Japanese: "bg-pink-500",
  };

  // í‚¤ ì¡°ì ˆ í¬ë§·íŒ… í•¨ìˆ˜
  const formatKeyAdjustment = (keyAdjustment: number | null | undefined) => {
    if (keyAdjustment === null || keyAdjustment === undefined) return null;
    if (keyAdjustment === 0) return "ì›ë³¸í‚¤";
    return keyAdjustment > 0 ? `+${keyAdjustment}í‚¤` : `${keyAdjustment}í‚¤`;
  };

  // í‘œì‹œí•  ì œëª©ê³¼ ì•„í‹°ìŠ¤íŠ¸ ê²°ì •
  const displayTitle = song.titleAlias || song.title;
  const displayArtist = song.artistAlias || song.artist;

  // YouTube URLì—ì„œ ë¹„ë””ì˜¤ ID ì¶”ì¶œ
  const getYouTubeVideoId = (url: string) => {
    const regex =
      /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    return match ? match[1] : null;
  };

  // MR ë§í¬ì—ì„œ YouTube URL ì°¾ê¸°
  const getYouTubeMRLink = () => {
    // mrLinks ì‚¬ìš©
    const mrLinks = song.mrLinks;
    if (!mrLinks || mrLinks.length === 0) return null;
    const selectedMR = mrLinks[song.selectedMRIndex || 0];
    if (!selectedMR) return null;

    // URLì— ì‹œê°„ íŒŒë¼ë¯¸í„° ì¶”ê°€
    let urlWithTime = selectedMR.url;
    if (selectedMR.skipSeconds && selectedMR.skipSeconds > 0) {
      // ê¸°ì¡´ URLì— t íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
      const hasTimeParam =
        urlWithTime.includes("&t=") || urlWithTime.includes("?t=");
      if (!hasTimeParam) {
        const separator = urlWithTime.includes("?") ? "&" : "?";
        urlWithTime = `${urlWithTime}${separator}t=${selectedMR.skipSeconds}`;
      }
    }

    const videoId = getYouTubeVideoId(urlWithTime);
    return videoId
      ? {
          videoId,
          skipSeconds: selectedMR.skipSeconds || 0,
          fullUrl: urlWithTime,
        }
      : null;
  };

  const youtubeMR = getYouTubeMRLink();

  const handlePlay = (e: React.MouseEvent) => {
    e.stopPropagation();

    if (youtubeMR) {
      // MR ë§í¬ê°€ ìˆìœ¼ë©´ ìƒˆ ì°½ì—ì„œ ì—´ê¸°
      window.open(youtubeMR.fullUrl, "_blank");
    } else {
      // MR ë§í¬ê°€ ì—†ìœ¼ë©´ ê²€ìƒ‰ ê¸°ëŠ¥ ì‹¤í–‰
      handleMRSearch(e);
    }
  };

  const handleModalPlay = (e: React.MouseEvent) => {
    e.stopPropagation();

    if (youtubeMR) {
      // MR ë§í¬ê°€ ìˆì„ ë•Œë§Œ ì¬ìƒ ê¸°ëŠ¥ ì‹¤í–‰
      if (
        youtubePlayer &&
        typeof youtubePlayer.playVideo === "function" &&
        typeof youtubePlayer.pauseVideo === "function"
      ) {
        // í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì—ˆì„ ë•Œ
        try {
          if (isPlaying) {
            youtubePlayer.pauseVideo();
            setIsPlaying(false);
          } else {
            youtubePlayer.playVideo();
            setIsPlaying(true);
          }
        } catch (error) {
          console.warn("YouTube player control error:", error);
          // ì—ëŸ¬ ë°œìƒ ì‹œ MR íƒ­ìœ¼ë¡œ ì „í™˜
          setCurrentTab("mr");
        }
      } else {
        // í”Œë ˆì´ì–´ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì„ ë•Œ - MR íƒ­ìœ¼ë¡œ ì „í™˜
        console.log("YouTube player not ready, switching to MR tab");
        setCurrentTab("mr");
      }
    } else {
      // MR ë§í¬ê°€ ì—†ì„ ë•ŒëŠ” ê²€ìƒ‰ ê¸°ëŠ¥ ì‹¤í–‰
      handleMRSearch(e);
    }
  };

  const handleMRSearch = (e: React.MouseEvent) => {
    e.stopPropagation();
    // ì§ì ‘ YouTube ê²€ìƒ‰ ìˆ˜í–‰ (ë” ì•ˆì •ì )
    const searchQuery = encodeURIComponent(
      `${displayTitle} ${displayArtist} karaoke MR`
    );
    window.open(
      `https://www.youtube.com/results?search_query=${searchQuery}`,
      "_blank"
    );
  };

  const handleOpenInNewTab = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (youtubeMR) {
      window.open(youtubeMR.fullUrl, "_blank");
    }
  };

  const onYouTubeReady = (event: { target: YouTubePlayer | null }) => {
    // ì»´í¬ë„ŒíŠ¸ê°€ unmountëœ ê²½ìš° ì²˜ë¦¬ ì¤‘ë‹¨
    if (!event?.target) {
      console.log("YouTube player target is null, component may be unmounted");
      return;
    }

    console.log("YouTube player ready:", event.target);
    setYoutubePlayer(event.target);

    // í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ë©´ ìë™ ì¬ìƒ ë°©ì§€
    try {
      if (event.target && typeof event.target.pauseVideo === "function") {
        // ë” ê¸´ ì§€ì—°ìœ¼ë¡œ í”Œë ˆì´ì–´ ì™„ì „ ì´ˆê¸°í™” ëŒ€ê¸°
        setTimeout(() => {
          try {
            // ë‹¤ì‹œ í•œë²ˆ null ì²´í¬ (ì»´í¬ë„ŒíŠ¸ê°€ unmountë  ìˆ˜ ìˆìŒ)
            if (!event?.target) return;

            // í”Œë ˆì´ì–´ ìƒíƒœë¥¼ í™•ì¸í•œ í›„ ì¼ì‹œì •ì§€ ì‹œë„
            if (typeof event.target.getPlayerState === "function") {
              const playerState = event.target.getPlayerState();
              if (playerState !== undefined && playerState !== -1) {
                event.target.pauseVideo();
                setIsPlaying(false);
              }
            } else {
              // getPlayerStateê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì¼ì‹œì •ì§€ ì‹œë„
              event.target.pauseVideo();
              setIsPlaying(false);
            }
          } catch (err) {
            // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì¡°ìš©íˆ ì²˜ë¦¬ (í”Œë ˆì´ì–´ê°€ ì•„ì§ ì™„ì „íˆ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°)
            console.log(
              "Failed to pause video on ready (normal during initialization)"
            );
          }
        }, 500); // ì§€ì—° ì‹œê°„ì„ ëŠ˜ë¦¼
      }
    } catch (error) {
      console.warn("YouTube player ready error:", error);
    }
  };

  const onYouTubeStateChange = (event: { data: number }) => {
    // ì»´í¬ë„ŒíŠ¸ê°€ unmountëœ ê²½ìš° ì²˜ë¦¬ ì¤‘ë‹¨
    if (!event || typeof event.data !== 'number') {
      console.log("YouTube state change event is invalid, component may be unmounted");
      return;
    }

    try {
      // YouTube í”Œë ˆì´ì–´ ìƒíƒœì™€ ë™ê¸°í™”
      // -1: ì‹œì‘ë˜ì§€ ì•ŠìŒ, 0: ì¢…ë£Œ, 1: ì¬ìƒ ì¤‘, 2: ì¼ì‹œì •ì§€, 3: ë²„í¼ë§, 5: ë™ì˜ìƒ ì‹ í˜¸
      const playerState = event.data;
      const isCurrentlyPlaying = playerState === 1;
      setIsPlaying(isCurrentlyPlaying);
    } catch (error) {
      console.warn("YouTube state change error:", error);
    }
  };

  const switchTab = (tab: "lyrics" | "mr" | "videos") => {
    setCurrentTab(tab);
  };

  const handleLike = async (e: React.MouseEvent) => {
    e.stopPropagation();
    await toggleLike();
  };

  const handlePlaylistClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
    if (!songPlaylists || songPlaylists.length === 0) {
      console.log("ğŸ”’ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤");
      return;
    }
    const rect = e.currentTarget.getBoundingClientRect();
    setMenuPosition({
      x: rect.left,
      y: rect.bottom + 8,
    });
    setShowPlaylistMenu(true);
  };

  const handleContextMenu = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setMenuPosition({
      x: e.clientX,
      y: e.clientY,
    });
    setShowPlaylistMenu(true);
  };

  // ì‹¤ì œ ë·°í¬íŠ¸ ë†’ì´ ê³„ì‚° ë° body ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™”
  useEffect(() => {
    const setViewportHeight = () => {
      // ì‹¤ì œ ë·°í¬íŠ¸ ë†’ì´ ê³„ì‚° (ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½/ë©”ë‰´ë°” ê³ ë ¤)
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty("--vh", `${vh}px`);

      // ëª¨ë°”ì¼ í™”ë©´ ì—¬ë¶€ ì²´í¬
      setIsMobileScreen(window.innerWidth < 640);
    };

    if (isExpanded) {
      // ë·°í¬íŠ¸ ë†’ì´ ì„¤ì •
      setViewportHeight();

      // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ëª¨ë°”ì¼ì—ì„œ ì£¼ì†Œì°½ì´ ì‚¬ë¼ì§ˆ ë•Œ ê°ì§€)
      window.addEventListener("resize", setViewportHeight);
      window.addEventListener("orientationchange", setViewportHeight);

      // body ìŠ¤í¬ë¡¤ ì™„ì „ ë¹„í™œì„±í™”
      document.body.style.overflow = "hidden";
      document.body.style.paddingRight = "0px"; // ìŠ¤í¬ë¡¤ë°” ê³µê°„ ë³´ì •
      document.body.style.touchAction = "none"; // í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€
      document.documentElement.style.overflow = "hidden"; // html ìš”ì†Œë„ ì°¨ë‹¨
    } else {
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
      window.removeEventListener("resize", setViewportHeight);
      window.removeEventListener("orientationchange", setViewportHeight);

      // body ìŠ¤í¬ë¡¤ ë³µì›
      document.body.style.overflow = "";
      document.body.style.paddingRight = "";
      document.body.style.touchAction = "";
      document.documentElement.style.overflow = "";
      // ëª¨ë‹¬ì´ ë‹«í ë•Œ YouTube í”Œë ˆì´ì–´ ì´ˆê¸°í™”
      setYoutubePlayer(null);
      setIsPlaying(false);
      setCurrentTab("lyrics");
    }

    // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì •ë¦¬
    return () => {
      window.removeEventListener("resize", setViewportHeight);
      window.removeEventListener("orientationchange", setViewportHeight);
      document.body.style.overflow = "";
      document.body.style.paddingRight = "";
      document.body.style.touchAction = "";
      document.documentElement.style.overflow = "";
      setYoutubePlayer(null);
      setIsPlaying(false);
    };
  }, [isExpanded]);

  // ë‹¤ì´ì–¼ë¡œê·¸ ìƒíƒœ ë³€ê²½ ì‹œ ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì— ì•Œë¦¼
  useEffect(() => {
    if (onDialogStateChange) {
      onDialogStateChange(isExpanded);
    }
  }, [isExpanded, onDialogStateChange]);

  // ë‹¤ì´ì–¼ë¡œê·¸ ì „ì²´ì—ì„œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì™„ì „ ì°¨ë‹¨
  const handleDialogScroll = (e: React.WheelEvent) => {
    e.stopPropagation();

    // passive ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ê²½ê³  ë°©ì§€ - ì´ë²¤íŠ¸ê°€ cancellableì¼ ë•Œë§Œ preventDefault í˜¸ì¶œ
    if (e.cancelable) {
      e.preventDefault();
    }

    // ì¶”ê°€ ë³´ì•ˆ: ë„¤ì´í‹°ë¸Œ ì´ë²¤íŠ¸ë„ ì°¨ë‹¨
    if (e.nativeEvent) {
      e.nativeEvent.stopImmediatePropagation();
    }
  };

  // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ì—­ì—ì„œë§Œ ìŠ¤í¬ë¡¤ í—ˆìš©
  const handleScrollableAreaScroll = (e: React.WheelEvent) => {
    e.stopPropagation();
    // ì—¬ê¸°ì„œëŠ” preventDefaultë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì•„ ìì—°ìŠ¤ëŸ¬ìš´ ìŠ¤í¬ë¡¤ í—ˆìš©
  };

  // MR í”Œë ˆì´ì–´ & LiveClip ìœ„ì¹˜ ê³„ì‚° ë° í‘œì‹œ ì¡°ê±´
  useEffect(() => {
    if (!isExpanded || isEditMode) return;

    const updatePositions = () => {
      const xlScreen = window.innerWidth >= 1280;
      setIsXLScreen((prev) => (prev !== xlScreen ? xlScreen : prev));

      // MR í”Œë ˆì´ì–´ ìœ„ì¹˜ ê³„ì‚°
      if (youtubeMR) {
        let playerTargetContainer = null;

        if (xlScreen && (currentTab === "mr" || currentTab === "lyrics")) {
          playerTargetContainer = document.getElementById("xl-player-target");
        } else if (!xlScreen && currentTab === "mr") {
          playerTargetContainer = document.getElementById(
            "mobile-player-target"
          );
        }

        if (playerTargetContainer) {
          const targetRect = playerTargetContainer.getBoundingClientRect();
          const computedStyle = window.getComputedStyle(playerTargetContainer);

          // íŒ¨ë”©ê³¼ ë³´ë”ë¥¼ ì œì™¸í•œ ì‹¤ì œ ë‚´ë¶€ í¬ê¸° ê³„ì‚°
          const paddingLeft = parseFloat(computedStyle.paddingLeft) || 0;
          const paddingRight = parseFloat(computedStyle.paddingRight) || 0;
          const paddingTop = parseFloat(computedStyle.paddingTop) || 0;
          const paddingBottom = parseFloat(computedStyle.paddingBottom) || 0;

          const borderLeft = parseFloat(computedStyle.borderLeftWidth) || 0;
          const borderRight = parseFloat(computedStyle.borderRightWidth) || 0;
          const borderTop = parseFloat(computedStyle.borderTopWidth) || 0;
          const borderBottom = parseFloat(computedStyle.borderBottomWidth) || 0;

          const actualWidth = Math.max(
            0,
            targetRect.width -
              paddingLeft -
              paddingRight -
              borderLeft -
              borderRight
          );
          const actualHeight = Math.max(
            0,
            targetRect.height -
              paddingTop -
              paddingBottom -
              borderTop -
              borderBottom
          );

          const newPosition = {
            top: targetRect.top + paddingTop + borderTop,
            left: targetRect.left + paddingLeft + borderLeft,
            width: actualWidth,
            height: actualHeight,
          };

          setPlayerPosition((prev) => {
            if (
              prev.top !== newPosition.top ||
              prev.left !== newPosition.left ||
              prev.width !== newPosition.width ||
              prev.height !== newPosition.height
            ) {
              return newPosition;
            }
            return prev;
          });
        }
      }

      // LiveClip ìœ„ì¹˜ ê³„ì‚°
      if (currentTab === "videos") {
        let liveClipTargetContainer = null;

        if (xlScreen) {
          liveClipTargetContainer =
            document.getElementById("xl-liveclip-target");
        } else {
          liveClipTargetContainer = document.getElementById(
            "mobile-liveclip-target"
          );
        }

        if (liveClipTargetContainer) {
          const targetRect = liveClipTargetContainer.getBoundingClientRect();
          const computedStyle = window.getComputedStyle(
            liveClipTargetContainer
          );

          // íŒ¨ë”©ê³¼ ë³´ë”ë¥¼ ì œì™¸í•œ ì‹¤ì œ ë‚´ë¶€ í¬ê¸° ê³„ì‚°
          const paddingLeft = parseFloat(computedStyle.paddingLeft) || 0;
          const paddingRight = parseFloat(computedStyle.paddingRight) || 0;
          const paddingTop = parseFloat(computedStyle.paddingTop) || 0;
          const paddingBottom = parseFloat(computedStyle.paddingBottom) || 0;

          const borderLeft = parseFloat(computedStyle.borderLeftWidth) || 0;
          const borderRight = parseFloat(computedStyle.borderRightWidth) || 0;
          const borderTop = parseFloat(computedStyle.borderTopWidth) || 0;
          const borderBottom = parseFloat(computedStyle.borderBottomWidth) || 0;

          const actualWidth = Math.max(
            0,
            targetRect.width -
              paddingLeft -
              paddingRight -
              borderLeft -
              borderRight
          );
          const actualHeight = Math.max(
            0,
            targetRect.height -
              paddingTop -
              paddingBottom -
              borderTop -
              borderBottom
          );

          const newLiveClipPosition = {
            top: targetRect.top + paddingTop + borderTop,
            left: targetRect.left + paddingLeft + borderLeft,
            width: actualWidth,
            height: actualHeight,
          };

          setLiveClipPosition((prev) => {
            if (
              prev.top !== newLiveClipPosition.top ||
              prev.left !== newLiveClipPosition.left ||
              prev.width !== newLiveClipPosition.width ||
              prev.height !== newLiveClipPosition.height
            ) {
              return newLiveClipPosition;
            }
            return prev;
          });
        }
      }
    };

    // ì´ˆê¸° ìœ„ì¹˜ ê³„ì‚°
    updatePositions();

    // ë¦¬ì‚¬ì´ì¦ˆ ë° ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    const handleResize = () => {
      // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì•½ê°„ì˜ ì§€ì—°ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
      setTimeout(updatePositions, 50);
    };

    window.addEventListener("resize", handleResize);
    window.addEventListener("scroll", updatePositions, { passive: true });

    return () => {
      window.removeEventListener("resize", handleResize);
      window.removeEventListener("scroll", updatePositions);
    };
  }, [isExpanded, currentTab, isEditMode, youtubeMR]);

  const handleCardClick = async () => {
    // ê³¡ ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥
    console.group(`ğŸµ ${song.title} - ${song.artist}`);
    console.log("ğŸ“‹ ê¸°ë³¸ ì •ë³´:", {
      title: song.title,
      artist: song.artist,
      language: song.language,
      id: song.id,
    });

    if (song.titleAlias || song.artistAlias) {
      console.log("ğŸ·ï¸ ë³„ì¹­ ì •ë³´:", {
        titleAlias: song.titleAlias,
        artistAlias: song.artistAlias,
      });
    }

    if (song.sungCount !== undefined || song.lastSungDate) {
      console.log("ğŸ“Š í™œë™ ì •ë³´:", {
        sungCount: song.sungCount,
        lastSungDate: song.lastSungDate,
        keyAdjustment: song.keyAdjustment ?? null,
      });
    }

    if (song.mrLinks?.length) {
      console.log("ğŸ¤ MR ì •ë³´:", {
        mrLinks: song.mrLinks,
        selectedMRIndex: song.selectedMRIndex,
      });
    }

    if (songPlaylists?.length || song.searchTags?.length) {
      console.log("ğŸ·ï¸ íƒœê·¸/í”Œë ˆì´ë¦¬ìŠ¤íŠ¸:", {
        tags: song.tags,
        searchTags: song.searchTags,
        playlists: songPlaylists,
      });
    }

    if (song.lyrics) {
      console.log(
        "ğŸ“ ê°€ì‚¬:",
        song.lyrics.substring(0, 100) + (song.lyrics.length > 100 ? "..." : "")
      );
    }

    if (song.personalNotes) {
      console.log("ğŸ“ ê°œì¸ ë©”ëª¨:", song.personalNotes);
    }

    console.log("ğŸ” ì „ì²´ ê°ì²´:", song);
    console.groupEnd();

    // ë‹¤ì´ì–¼ë¡œê·¸ í† ê¸€ - ë‹«ì„ ë•ŒëŠ” ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
    if (isExpanded) {
      handleCloseDialog();
    } else {
      setIsExpanded(true);
    }
  };

  // ================ UI ë Œë”ë§ í•¨ìˆ˜ë“¤ ================

  // XL í™”ë©´ ì™¼ìª½ ê°€ì‚¬ ì˜ì—­ ë Œë”ë§
  const renderXLLyricsPanel = () => (
    <div className="hidden xl:flex xl:w-1/2 flex-col min-h-0">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <MusicalNoteIcon className="w-6 h-6 text-light-accent dark:text-dark-accent" />
          <h4 className="text-lg sm:text-xl md:text-2xl font-semibold text-light-text dark:text-dark-text">
            ê°€ì‚¬
          </h4>
        </div>

        {/* XL í™”ë©´ ì „ìš© OBS ì»¨íŠ¸ë¡¤ - ë” í° í¬ê¸°ì™€ ëª…í™•í•œ ë ˆì´ë¸” */}
        <div className="flex items-center gap-3">
          {/* OBS ë§í¬ ë³µì‚¬ ë²„íŠ¼ - OBS í™œì„±í™” ì‹œì—ë§Œ ë‚˜íƒ€ë‚¨ (ì™¼ìª½ì— ë°°ì¹˜) */}
          <motion.div
            initial={false}
            animate={{
              opacity: obsActive ? 1 : 0,
              scale: obsActive ? 1 : 0.8,
              width: obsActive ? 120 : 0,
            }}
            transition={{ duration: 0.2, ease: "easeInOut" }}
            className="overflow-hidden"
          >
            {obsActive && (
              <button
                onClick={copyOBSLink}
                className="flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-500/10 hover:bg-blue-500/20 
                           text-blue-600 dark:text-blue-400 border-2 border-blue-500/20 hover:border-blue-500/30
                           transition-all duration-200 w-28 justify-center whitespace-nowrap"
                title="OBS ë§í¬ ë³µì‚¬"
              >
                <DocumentDuplicateIcon className="w-5 h-5" />
                <span className="text-sm font-medium">ë§í¬ ë³µì‚¬</span>
              </button>
            )}
          </motion.div>

          {/* OBS í† ê¸€ ë²„íŠ¼ - ê³ ì • ìœ„ì¹˜ (ì˜¤ë¥¸ìª½ì— ë°°ì¹˜) */}
          <button
            onClick={toggleOBS}
            disabled={obsLoading}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-200 disabled:opacity-50 w-24 justify-center ${
              obsActive
                ? "bg-green-500/20 text-green-600 dark:text-green-400 border-2 border-green-500/30"
                : "bg-light-primary/10 dark:bg-dark-primary/10 text-light-accent dark:text-dark-accent border-2 border-light-primary/20 dark:border-dark-primary/20 hover:bg-light-primary/20 dark:hover:bg-dark-primary/20"
            }`}
            title={obsActive ? "OBS í‘œì‹œ ë„ê¸°" : "OBS í‘œì‹œ ì¼œê¸°"}
          >
            {obsLoading ? (
              <motion.div
                animate={{ rotate: 360 }}
                transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
                className="w-5 h-5 border-2 border-light-accent/30 border-t-light-accent rounded-full dark:border-dark-accent/30 dark:border-t-dark-accent"
              />
            ) : (
              <>
                <ComputerDesktopIcon className="w-5 h-5" />
                <span className="text-sm font-medium">OBS</span>
              </>
            )}
          </button>
        </div>
      </div>

      <div className="flex-1 p-2 sm:p-3 lg:p-6 bg-light-primary/5 dark:bg-dark-primary/5 rounded-lg border border-light-primary/20 dark:border-dark-primary/20 flex flex-col min-h-0">
        {isEditMode ? (
          <textarea
            value={lyricsText}
            onChange={(e) => handleLyricsChange(e.target.value)}
            className="text-light-text/80 dark:text-dark-text/80 whitespace-pre-line leading-relaxed text-sm sm:text-base md:text-lg 
                       bg-transparent border border-light-accent/30 dark:border-dark-accent/30 rounded-lg p-3 sm:p-4 
                       outline-none resize-none flex-1 min-h-0"
            placeholder="ê°€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
            style={{
              willChange: "scroll-position",
              transform: "translateZ(0)",
            }}
          />
        ) : song.lyrics ? (
          <div
            className="scrollable-content text-light-text/80 dark:text-dark-text/80 whitespace-pre-line leading-relaxed text-sm sm:text-base md:text-lg overflow-y-auto flex-1 min-h-0"
            style={{
              overscrollBehavior: "contain",
              willChange: "scroll-position",
              transform: "translateZ(0)",
            }}
          >
            {song.lyrics}
          </div>
        ) : (
          <div className="text-center flex flex-col items-center justify-center text-light-text/50 dark:text-dark-text/50 flex-1">
            <MusicalNoteIcon className="w-16 h-16 mb-4 opacity-30" />
            <p className="text-base sm:text-lg md:text-xl mb-2">ì•„ì§ ê°€ì‚¬ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p>
            <p className="text-base">ê³§ ì—…ë°ì´íŠ¸ë  ì˜ˆì •ì…ë‹ˆë‹¤</p>
          </div>
        )}
      </div>
    </div>
  );


  // ì¼ë°˜ ëª¨ë“œ í—¤ë” ë Œë”ë§
  const renderNormalModeHeader = () => (
    <div className="relative">
      {/* ì½˜í…ì¸  ì˜ì—­: ì œëª©, ì•„í‹°ìŠ¤íŠ¸, íƒœê·¸ë“¤ */}
      <div className="min-w-0 pr-16 sm:pr-20">
        <div className="flex items-center gap-2 sm:gap-3 mb-1 sm:mb-2 mr-20 sm:mr-20 xl:mr-10">
          <h3
            className="text-lg sm:text-xl md:text-2xl lg:text-3xl font-semibold text-light-text dark:text-dark-text 
                         text-light-accent dark:text-dark-accent flex-1 min-w-0"
          >
            {displayTitle}
          </h3>
        </div>
        <div className="flex items-center gap-1 sm:gap-2 flex-wrap mb-1 sm:mb-2">
          <p className="text-sm sm:text-base md:text-lg lg:text-xl text-light-text/70 dark:text-dark-text/70 line-clamp-1">
            {displayArtist}
          </p>
          {formatKeyAdjustment(song.keyAdjustment) && (
            <span
              className="px-2 py-1 text-xs font-medium rounded-full 
                           bg-blue-500/20 text-blue-600 dark:text-blue-400"
            >
              {formatKeyAdjustment(song.keyAdjustment)}
            </span>
          )}
          {song.language && (
            <span
              className={`px-2 py-1 rounded-full text-xs font-medium text-white 
                             ${
                               languageColors[
                                 song.language as keyof typeof languageColors
                               ] || "bg-gray-500"
                             }`}
            >
              {song.language}
            </span>
          )}
          {/* ê²€ìƒ‰ íƒœê·¸ë“¤ */}
          {song.searchTags && song.searchTags.length > 0 && (
            <div className="flex flex-wrap gap-1">
              {song.searchTags.map((tag, index) => (
                <span
                  key={index}
                  className="px-2 py-1 text-xs bg-light-secondary/20 dark:bg-dark-secondary/20 
                           text-light-text/70 dark:text-dark-text/70 rounded-full"
                >
                  #{tag}
                </span>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* ëª¨ë“  í™”ë©´ì—ì„œ ë²„íŠ¼ë“¤ - ì ˆëŒ€ ìœ„ì¹˜ë¡œ ì œëª© ì˜¤ë¥¸ìª½ì— ë°°ì¹˜ */}
      <div className="absolute top-0 right-0 flex gap-2 z-10">
        {/* OBS í† ê¸€ ë²„íŠ¼ - XL í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€ */}
        <>
          {obsActive && (
            <motion.button
              initial={{ opacity: 0, scale: 0.8 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.8 }}
              transition={{ duration: 0.2 }}
              onClick={copyOBSLink}
              className="xl:hidden w-8 h-8 flex items-center justify-center rounded-full hover:bg-light-primary/20 dark:hover:bg-dark-primary/20 
                         transition-colors duration-200 text-blue-600 dark:text-blue-400"
              title="OBS ë§í¬ ë³µì‚¬"
            >
              <DocumentDuplicateIcon className="w-4 h-4" />
            </motion.button>
          )}
          <button
            onClick={toggleOBS}
            disabled={obsLoading}
            className={`xl:hidden w-8 h-8 flex items-center justify-center rounded-full hover:bg-light-primary/20 dark:hover:bg-dark-primary/20 
                       transition-all duration-200 disabled:opacity-50 ${
                         obsActive
                           ? "bg-green-500/20 text-green-600 dark:text-green-400"
                           : "text-light-accent dark:text-dark-accent"
                       }`}
            title={obsActive ? "OBS í‘œì‹œ ë„ê¸°" : "OBS í‘œì‹œ ì¼œê¸°"}
          >
            {obsLoading ? (
              <motion.div
                animate={{ rotate: 360 }}
                transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
                className="w-4 h-4 border-2 border-light-accent/30 border-t-light-accent rounded-full dark:border-dark-accent/30 dark:border-t-dark-accent"
              />
            ) : (
              <ComputerDesktopIcon className="w-4 h-4" />
            )}
          </button>
        </>
        {isAdmin && (
          <button
            onClick={toggleEditMode}
            className="p-1.5 rounded-full hover:bg-light-primary/20 dark:hover:bg-dark-primary/20 
                       transition-colors duration-200"
            title="í¸ì§‘"
          >
            <PencilIcon className="w-4 h-4 text-light-accent dark:text-dark-accent" />
          </button>
        )}
        <button
          onClick={handleLike}
          disabled={likeLoading}
          className="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/5 dark:bg-gray-800/50
                     hover:bg-light-primary/10 dark:hover:bg-dark-primary/10 
                     transition-all duration-200 disabled:opacity-50 backdrop-blur-sm
                     border border-white/10 dark:border-gray-700/50"
          title={liked ? "ì¢‹ì•„ìš” ì·¨ì†Œ" : "ì¢‹ì•„ìš”"}
        >
          <HeartIcon
            className={`w-4 h-4 transition-all duration-200 
                       ${
                         likeLoading
                           ? "text-red-400 fill-current opacity-60 animate-pulse scale-110"
                           : liked
                           ? "text-red-500 fill-current"
                           : "text-light-text/60 dark:text-dark-text/60 hover:text-red-400"
                       }`}
          />
          {song.likeCount !== undefined && (
            <span
              className={`text-xs font-medium transition-all duration-200 min-w-[1rem] text-center ${
                liked
                  ? "text-red-500"
                  : "text-light-text/70 dark:text-dark-text/70"
              }`}
            >
              {song.likeCount}
            </span>
          )}
        </button>

        {/* ë¶€ë¥¸ íšŸìˆ˜ í‘œì‹œ */}
        {song.sungCount !== undefined && song.sungCount > 0 && (
          <div
            className="flex items-center gap-1 px-2 py-1 rounded-full
                         bg-green-500/10 dark:bg-green-500/20 
                         border border-green-500/20 dark:border-green-500/30"
          >
            <span className="text-xs font-medium text-green-600 dark:text-green-400">
              ğŸ¤ {song.sungCount}
            </span>
          </div>
        )}

        <button
          onClick={handleCloseDialog}
          className="p-1.5 rounded-full bg-red-500/20 hover:bg-red-500/30 
                     transition-colors duration-200"
          title="ë‹«ê¸°"
        >
          <XMarkIcon className="w-4 h-4 text-red-500" />
        </button>
      </div>
    </div>
  );

  // SongCard ì»´í¬ë„ŒíŠ¸ ë©”ì¸ ë Œë”ë§
  return (
    <>
      {/* ì¼ë°˜ ì¹´ë“œ */}
      {!isExpanded && (
        <motion.div
          initial={{ opacity: 0, scale: 0.9, x: "-50%", y: "-10%" }}
          animate={{ opacity: 1, scale: 1, x: "-50%", y: "0%" }}
          exit={{ opacity: 0, scale: 0.9, x: "-50%", y: "-10%" }}
          transition={{ duration: 0.3 }}
          className="fixed top-20 sm:top-20 left-1/2 z-40 
                     w-[95vw] max-w-[1600px] overflow-y-auto xl:overflow-hidden
                     bg-white dark:bg-gray-900 backdrop-blur-sm 
                     rounded-xl border border-light-primary/20 dark:border-dark-primary/20 
                     shadow-2xl transform -translate-x-1/2 youtube-dialog-container
                     overscroll-behavior-contain"
          style={{
            top: isMobileScreen ? "4.5rem" : "5rem", // ëª¨ë°”ì¼: ë„¤ë¹„ê²Œì´ì…˜ ë°”(4rem) + 0.5rem ì—¬ë°±
            height: isMobileScreen
              ? "calc(var(--vh, 1vh) * 100 - 5rem)"
              : "calc(var(--vh, 1vh) * 100 - 6rem)",
            overscrollBehavior: "contain",
          }}
          onWheel={handleDialogScroll}
        >
          {/* Background gradient overlay */}
          <div
            className="absolute inset-0 bg-gradient-to-br from-light-accent/5 to-light-purple/5 
                          dark:from-dark-accent/5 dark:to-dark-purple/5 rounded-xl"
          ></div>

          <div className="relative p-4 sm:p-6 xl:p-8 flex flex-col xl:flex-row h-full gap-4 sm:gap-6 xl:gap-8 xl:overflow-hidden">
            {/* ì™¼ìª½: ê°€ì‚¬ ì „ìš© ì˜ì—­ (XL ì´ìƒì—ì„œë§Œ) */}
            {renderXLLyricsPanel()}

            {/* ì˜¤ë¥¸ìª½: ëª¨ë“  ë‹¤ë¥¸ ìš”ì†Œë“¤ */}
            <div className={`flex-1 xl:w-1/2 flex flex-col min-h-0 relative xl:overflow-y-auto xl:overscroll-behavior-contain ${isEditMode ? 'xl:pr-6' : ''}`}>
              {/* Header */}
              <div className="mb-3 sm:mb-4">
                {isEditMode ? (
                  <SongEditForm
                    song={song}
                    isVisible={true}
                    onSave={handleSaveEdit}
                    onCancel={cancelEdit}
                    onLyricsChange={handleLyricsChange}
                    initialLyrics={lyricsText}
                  />
                ) : (
                  renderNormalModeHeader()
                )}
              </div>

              {/* Legacy Tags (if exists) */}
              {song.tags && song.tags.length > 0 && (
                <div className="flex flex-wrap gap-1 mb-2 sm:mb-4">
                  {song.tags.map((tag: string, index: number) => (
                    <span
                      key={index}
                      className="px-2 py-1 rounded-full text-xs 
                               bg-light-secondary/20 dark:bg-dark-secondary/20 
                               text-light-text/70 dark:text-dark-text/70"
                    >
                      #{tag}
                    </span>
                  ))}
                </div>
              )}

              {/* í° í™”ë©´ì—ì„œì˜ ì˜ìƒ ì„¹ì…˜ - í”Œë ˆì´ì–´ ëŒ€ìƒ ì˜ì—­, í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ìˆ¨ê¹€ */}
              {!isEditMode && (
                <div className="hidden xl:flex flex-col flex-1 gap-6 min-h-0">
                  <motion.div
                    initial={{ opacity: 0, height: 0 }}
                    animate={{ opacity: 1, height: "auto" }}
                    transition={{ duration: 0.3, delay: 0.1 }}
                    className="bg-light-primary/5 dark:bg-dark-primary/5 rounded-lg border border-light-primary/20 dark:border-dark-primary/20 flex flex-col flex-1 min-h-0"
                  >
                  {/* XL í™”ë©´ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
                  <div className="flex border-b border-light-primary/20 dark:border-dark-primary/20 mb-4">
                    <button
                      onClick={() => switchTab("mr")}
                      className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ${
                        currentTab === "mr"
                          ? "text-light-accent dark:text-dark-accent border-b-2 border-light-accent dark:border-dark-accent bg-light-primary/10 dark:bg-dark-primary/10"
                          : "text-gray-600 dark:text-gray-400 hover:text-light-accent dark:hover:text-dark-accent hover:bg-light-primary/5 dark:hover:bg-dark-primary/5"
                      }`}
                    >
                      <VideoCameraIcon className="w-5 h-5" />
                      <span>{isEditMode ? "MR ë§í¬ ê´€ë¦¬" : "MR ì˜ìƒ"}</span>
                    </button>
                    <button
                      onClick={() => switchTab("videos")}
                      className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ${
                        currentTab === "videos"
                          ? "text-light-accent dark:text-dark-accent border-b-2 border-light-accent dark:border-dark-accent bg-light-primary/10 dark:bg-dark-primary/10"
                          : "text-gray-600 dark:text-gray-400 hover:text-light-accent dark:hover:text-dark-accent hover:bg-light-primary/5 dark:hover:bg-dark-primary/5"
                      }`}
                    >
                      <PlayIcon className="w-5 h-5" />
                      <span>ë¼ì´ë¸Œ í´ë¦½</span>
                    </button>
                  </div>

                  {/* XL í™”ë©´ MR ì„¹ì…˜ */}
                    <div
                      className={`${
                        currentTab === "mr" ? "flex" : "hidden"
                      } flex-col flex-1 min-h-0`}
                    >
                      {/* ê¸°ì¡´ YouTube í”Œë ˆì´ì–´ */}
                      {youtubeMR && (
                        <div
                          id="xl-player-target"
                          className="w-full flex-1 min-h-0 bg-gray-50 dark:bg-gray-800 rounded-lg"
                          style={{
                            height: "100%",
                            maxHeight: "100%",
                            overflow: "hidden",
                          }}
                        >
                          {/* í†µí•© í”Œë ˆì´ì–´ê°€ ì—¬ê¸°ì— ìœ„ì¹˜í•¨ */}
                        </div>
                      )}
                    </div>

                  {/* XL í™”ë©´ ìœ íŠœë¸Œ ì˜ìƒ ì„¹ì…˜ */}
                  <div
                    className={`${
                      currentTab === "videos" ? "flex" : "hidden"
                    } flex-col h-full min-h-0 relative`}
                  >
                    <div
                      id="xl-liveclip-target"
                      className="w-full flex-1 min-h-0 bg-gray-50 dark:bg-gray-800 rounded-lg"
                      style={{
                        height: "100%",
                        maxHeight: "100%",
                        overflow: "hidden",
                      }}
                    >
                      {/* í†µí•© LiveClip Managerê°€ ì—¬ê¸°ì— ìœ„ì¹˜í•¨ */}
                    </div>
                  </div>
                </motion.div>
              </div>
              )}

              {/* ì‘ì€ í™”ë©´ì—ì„œì˜ íƒ­ ì„¹ì…˜ - í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ìˆ¨ê¹€ */}
              {!isEditMode && (
                <motion.div
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  transition={{ duration: 0.3, delay: 0.1 }}
                  className="xl:hidden bg-light-primary/5 dark:bg-dark-primary/5 rounded-lg border border-light-primary/20 dark:border-dark-primary/20 relative flex flex-col flex-1 min-h-0"
                >
                {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
                <div className="flex border-b border-light-primary/20 dark:border-dark-primary/20">
                  <button
                    onClick={() => switchTab("lyrics")}
                    className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ${
                      currentTab === "lyrics"
                        ? "text-light-accent dark:text-dark-accent border-b-2 border-light-accent dark:border-dark-accent bg-light-primary/10 dark:bg-dark-primary/10"
                        : "text-gray-600 dark:text-gray-400 hover:text-light-accent dark:hover:text-dark-accent hover:bg-light-primary/5 dark:hover:bg-dark-primary/5"
                    }`}
                  >
                    <MusicalNoteIcon className="w-4 h-4" />
                    <span>ê°€ì‚¬</span>
                  </button>
                  <button
                    onClick={() => switchTab("mr")}
                    className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ${
                      currentTab === "mr"
                        ? "text-light-accent dark:text-dark-accent border-b-2 border-light-accent dark:border-dark-accent bg-light-primary/10 dark:bg-dark-primary/10"
                        : "text-gray-600 dark:text-gray-400 hover:text-light-accent dark:hover:text-dark-accent hover:bg-light-primary/5 dark:hover:bg-dark-primary/5"
                    }`}
                  >
                    <VideoCameraIcon className="w-4 h-4" />
                    <span>MR</span>
                  </button>
                  <button
                    onClick={() => switchTab("videos")}
                    className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ${
                      currentTab === "videos"
                        ? "text-light-accent dark:text-dark-accent border-b-2 border-light-accent dark:border-dark-accent bg-light-primary/10 dark:bg-dark-primary/10"
                        : "text-gray-600 dark:text-gray-400 hover:text-light-accent dark:hover:text-dark-accent hover:bg-light-primary/5 dark:hover:bg-dark-primary/5"
                    }`}
                  >
                    <PlayIcon className="w-4 h-4" />
                    <span>ë¼ì´ë¸Œ í´ë¦½</span>
                  </button>
                </div>

                {/* íƒ­ ì½˜í…ì¸  */}
                <div
                  className={`flex-1 min-h-0 ${
                    currentTab === "videos" ? "" : "p-4 sm:p-6"
                  }`}
                >
                  {/* MR ì˜ìƒ/í¸ì§‘ ì˜ì—­ */}
                  <div
                    className={`${
                      currentTab === "mr" ? "flex" : "hidden"
                    } flex-col h-full min-h-0`}
                  >
                    {!isEditMode && (
                      /* ê¸°ì¡´ YouTube í”Œë ˆì´ì–´ */
                      youtubeMR && (
                        <div className="flex-1 flex flex-col min-h-0">
                          <div
                            id="mobile-player-target"
                            className="w-full bg-gray-50 dark:bg-gray-800 rounded-lg flex-1"
                            style={{
                              minHeight: "240px",
                              overflow: "hidden",
                            }}
                          >
                            {/* í†µí•© í”Œë ˆì´ì–´ê°€ ì—¬ê¸°ì— ìœ„ì¹˜í•¨ */}
                          </div>
                        </div>
                      )
                    )}
                  </div>

                  {/* ê°€ì‚¬ ì„¹ì…˜ */}
                  <div
                    className={`${
                      currentTab === "lyrics" ? "flex" : "hidden"
                    } flex-col h-full min-h-0`}
                  >
                    {isEditMode ? (
                      <textarea
                        value={lyricsText}
                        onChange={(e) => handleLyricsChange(e.target.value)}
                        className="text-light-text/80 dark:text-dark-text/80 whitespace-pre-line leading-relaxed text-sm sm:text-base md:text-lg 
                                   bg-transparent border border-light-accent/30 dark:border-dark-accent/30 rounded-lg p-4 
                                   outline-none resize-none w-full h-full"
                        placeholder="ê°€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        style={{
                          willChange: "scroll-position",
                          transform: "translateZ(0)",
                        }}
                      />
                    ) : song.lyrics ? (
                      <div
                        className="scrollable-content text-light-text/80 dark:text-dark-text/80 whitespace-pre-line leading-relaxed text-sm sm:text-base md:text-lg overflow-y-auto flex-1 min-h-0"
                        style={{
                          overscrollBehavior: "contain",
                          willChange: "scroll-position",
                          transform: "translateZ(0)",
                        }}
                        onWheel={handleScrollableAreaScroll}
                      >
                        {song.lyrics}
                      </div>
                    ) : (
                      <div className="text-center h-full flex flex-col items-center justify-center text-light-text/50 dark:text-dark-text/50">
                        <MusicalNoteIcon className="w-16 h-16 mb-4 opacity-30" />
                        <p className="text-base sm:text-lg md:text-xl mb-2">
                          ì•„ì§ ê°€ì‚¬ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
                        </p>
                        <p className="text-base">ê³§ ì—…ë°ì´íŠ¸ë  ì˜ˆì •ì…ë‹ˆë‹¤</p>
                      </div>
                    )}
                  </div>

                  {/* ìœ íŠœë¸Œ ì˜ìƒ ì„¹ì…˜ */}
                  <div
                    className={`${
                      currentTab === "videos" ? "flex" : "hidden"
                    } flex-col h-full min-h-0 relative`}
                  >
                    {/* í¸ì§‘ ëª¨ë“œì¼ ë•ŒëŠ” LiveClipEditor ì‚¬ìš© */}
                    {isEditMode ? (
                      <div className="h-full overflow-y-auto p-4" style={{maxHeight: '1000px'}}>
                        <LiveClipEditor
                          songId={song.id}
                          songTitle={displayTitle}
                          songVideos={songVideos}
                          setSongVideos={setSongVideos}
                          videosLoading={videosLoading}
                          loadSongVideos={loadSongVideos}
                        />
                      </div>
                    ) : (
                      /* LiveClip íƒ€ê²Ÿ ì˜ì—­ - MR í”Œë ˆì´ì–´ì™€ ë™ì¼í•œ íŒ¨í„´ */
                      <div
                        id="mobile-liveclip-target"
                        className="w-full bg-gray-50 dark:bg-gray-800 rounded-lg flex-1"
                        style={{
                          minHeight: "240px",
                          overflow: "hidden",
                        }}
                      >
                        {/* í†µí•© LiveClipì´ ì—¬ê¸°ì— ìœ„ì¹˜í•¨ */}
                      </div>
                    )}
                  </div>
                </div>
              </motion.div>
              )}

              {/* Action buttons - í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ */}
              {!isEditMode && (
                <div className="flex items-center gap-2 sm:gap-3 flex-wrap mt-3 sm:mt-4">
                  {youtubeMR ? (
                    // MR ë§í¬ê°€ ìˆì„ ë•Œ - 3ê°œ ë²„íŠ¼ìœ¼ë¡œ ë¶„ë¦¬
                    <>
                      {/* ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ */}
                      <button
                        onClick={handleModalPlay}
                        className="flex-1 flex items-center justify-center gap-2 px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base md:text-lg
                               bg-gradient-to-r from-light-accent to-light-purple 
                               dark:from-dark-accent dark:to-dark-purple text-white 
                               rounded-lg hover:shadow-lg transform hover:scale-105 
                               transition-all duration-200 font-medium"
                      >
                        {isPlaying ? (
                          <>
                            <PauseIcon className="w-5 h-5" />
                            <span>ì¼ì‹œì •ì§€</span>
                          </>
                        ) : (
                          <>
                            <PlayIcon className="w-5 h-5" />
                            <span>MR ì¬ìƒ</span>
                          </>
                        )}
                      </button>

                      {/* MR ê²€ìƒ‰ ë²„íŠ¼ */}
                      <button
                        onClick={handleMRSearch}
                        className="px-3 sm:px-4 py-2 sm:py-3 rounded-lg bg-light-primary/20 dark:bg-dark-primary/20 
                               hover:bg-light-primary/30 dark:hover:bg-dark-primary/30 
                               transition-colors duration-200 text-light-text dark:text-dark-text
                               flex items-center gap-2"
                        title="YouTubeì—ì„œ MR ê²€ìƒ‰"
                      >
                        <MagnifyingGlassIcon className="w-5 h-5" />
                        <span className="hidden sm:inline">MR ê²€ìƒ‰</span>
                      </button>

                      {/* ìƒˆ ì°½ì—ì„œ ì—´ê¸° ë²„íŠ¼ */}
                      <button
                        onClick={handleOpenInNewTab}
                        className="px-3 sm:px-4 py-2 sm:py-3 rounded-lg bg-light-primary/20 dark:bg-dark-primary/20 
                               hover:bg-light-primary/30 dark:hover:bg-dark-primary/30 
                               transition-colors duration-200 text-light-text dark:text-dark-text
                               flex items-center gap-2"
                        title="ìƒˆ ì°½ì—ì„œ MR ì—´ê¸°"
                      >
                        <ArrowTopRightOnSquareIcon className="w-5 h-5" />
                        <span className="hidden sm:inline">ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°</span>
                      </button>
                    </>
                  ) : (
                    // MR ë§í¬ê°€ ì—†ì„ ë•Œ - ê¸°ì¡´ ê²€ìƒ‰ ë²„íŠ¼
                    <button
                      onClick={handleMRSearch}
                      className="flex-1 flex items-center justify-center gap-1.5 sm:gap-2 px-3 sm:px-6 py-2 text-sm sm:text-base md:text-lg md:text-lg
                             bg-gradient-to-r from-light-accent to-light-purple 
                             dark:from-dark-accent dark:to-dark-purple text-white 
                             rounded-lg hover:shadow-lg transform hover:scale-105 
                             transition-all duration-200 font-medium"
                    >
                      <MagnifyingGlassIcon className="w-5 h-5" />
                      <span>MR ê²€ìƒ‰</span>
                    </button>
                  )}
                </div>
              )}

              {/* Date info - í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ */}
              {!isEditMode && (song.dateAdded || song.lastSungDate) && (
                <div className="mt-3 sm:mt-4 text-sm text-light-text/50 dark:text-dark-text/50 flex justify-between items-center">
                  {song.dateAdded && (
                    <div>
                      ì¶”ê°€ì¼:{" "}
                      {new Date(song.dateAdded).toLocaleDateString("ko-KR")}
                    </div>
                  )}
                  {song.lastSungDate && (
                    <div>
                      ë§ˆì§€ë§‰ ë¶€ë¥¸ ë‚ :{" "}
                      {new Date(song.lastSungDate).toLocaleDateString("ko-KR")}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </motion.div>
      )}

      {/* ì¼ë°˜ ì¹´ë“œ */}
      {!isExpanded && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          whileHover={{ y: -5 }}
          transition={{ duration: 0.3 }}
          onClick={handleCardClick}
          onContextMenu={handleContextMenu}
          className="group relative rounded-xl border border-light-primary/20 dark:border-dark-primary/20 
                     hover:shadow-xl transition-all duration-300 overflow-hidden cursor-pointer h-52"
        >
          {song.imageUrl ? (
            /* ì•¨ë²” ì´ë¯¸ì§€ê°€ ìˆì„ ë•Œ */
            <>
              {/* ì•¨ë²” ì´ë¯¸ì§€ ë°°ê²½ */}
              <div
                className="absolute inset-0 bg-cover bg-center transition-transform duration-500 group-hover:scale-110"
                style={{ backgroundImage: `url(${song.imageUrl})` }}
              />

              {/* ë¼ì´íŠ¸/ë‹¤í¬ëª¨ë“œë³„ ì˜¤ë²„ë ˆì´ */}
              <div
                className="absolute inset-0 bg-white/30 dark:bg-black/20 
                              group-hover:bg-white/25 dark:group-hover:bg-black/15 
                              transition-colors duration-300"
              />

              {/* í•˜ë‹¨ ê·¸ë¼ë°ì´ì…˜ */}
              <div
                className="absolute inset-0 bg-gradient-to-t 
                              from-white/60 via-white/15 to-transparent
                              dark:from-black/50 dark:via-black/10 dark:to-transparent"
              />

              <div className="relative p-6 bg-white/20 dark:bg-gray-900/20 backdrop-blur-[1px] h-full">
                {/* Header */}
                <div className="flex items-start justify-between mb-4">
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 flex-wrap mb-2">
                      <h3
                        className="text-lg font-semibold text-light-text dark:text-dark-text 
                                     line-clamp-1 group-hover:text-light-accent dark:group-hover:text-dark-accent 
                                     transition-colors duration-300 flex-1"
                      >
                        {showNumber && number && (
                          <span className="text-light-accent dark:text-dark-accent font-bold mr-2">
                            {number}.
                          </span>
                        )}
                        {displayTitle}
                      </h3>
                      {formatKeyAdjustment(song.keyAdjustment) && (
                        <span
                          className="px-2 py-1 text-xs font-medium rounded-md 
                                       bg-yellow-100 dark:bg-yellow-900 
                                       text-yellow-800 dark:text-yellow-200 flex-shrink-0"
                        >
                          {formatKeyAdjustment(song.keyAdjustment)}
                        </span>
                      )}
                    </div>
                    <p className="text-sm text-light-text/70 dark:text-dark-text/70 mb-3 line-clamp-1">
                      {displayArtist}
                    </p>
                  </div>
                  <div className="flex flex-col gap-2">
                    <button
                      onClick={handleLike}
                      disabled={likeLoading}
                      className="flex items-center justify-center gap-1 px-2 py-1 rounded-full
                                 bg-white/10 dark:bg-gray-800/50 backdrop-blur-sm
                                 hover:bg-light-primary/20 dark:hover:bg-dark-primary/20 
                                 transition-all duration-200 disabled:opacity-50
                                 border border-white/20 dark:border-gray-700/50"
                      title={liked ? "ì¢‹ì•„ìš” ì·¨ì†Œ" : "ì¢‹ì•„ìš”"}
                    >
                      <HeartIcon
                        className={`w-4 h-4 transition-all duration-200 
                                   ${
                                     likeLoading
                                       ? "text-red-400 fill-current opacity-60 animate-pulse scale-110"
                                       : liked
                                       ? "text-red-500 fill-current"
                                       : "text-light-text/60 dark:text-dark-text/60 hover:text-red-400"
                                   }`}
                      />
                      {song.likeCount !== undefined && (
                        <span
                          className={`text-xs font-medium transition-all duration-200 min-w-[1rem] text-center ${
                            liked
                              ? "text-red-500"
                              : "text-light-text/70 dark:text-dark-text/70"
                          }`}
                        >
                          {song.likeCount}
                        </span>
                      )}
                    </button>

                    {/* ë¶€ë¥¸ íšŸìˆ˜ í‘œì‹œ */}
                    {song.sungCount !== undefined && song.sungCount > 0 && (
                      <div
                        className="flex items-center justify-center gap-1 px-2 py-1 rounded-full
                                    bg-green-100/80 dark:bg-green-900/50 
                                    border border-green-200/50 dark:border-green-700/50"
                      >
                        <span className="text-xs font-medium text-green-700 dark:text-green-300">
                          ğŸ¤ {song.sungCount}
                        </span>
                      </div>
                    )}
                  </div>
                </div>

                {/* Language tag and playlist badges */}
                <div className="flex flex-wrap gap-2 mb-2">
                  {song.language && (
                    <span
                      className={`px-2 py-1 rounded-full text-xs font-medium text-white 
                                     ${
                                       languageColors[
                                         song.language as keyof typeof languageColors
                                       ] || "bg-gray-500"
                                     }`}
                    >
                      {song.language}
                    </span>
                  )}
                  {songPlaylists.slice(0, 2).map((playlist) => (
                    <span
                      key={playlist._id}
                      className="px-2 py-1 rounded-full text-xs font-medium
                               bg-purple-100 dark:bg-purple-900 
                               text-purple-800 dark:text-purple-200"
                    >
                      ğŸµ {playlist.name}
                    </span>
                  ))}
                  {songPlaylists.length > 2 && (
                    <span
                      className="px-2 py-1 rounded-full text-xs font-medium
                                   bg-gray-100 dark:bg-gray-800 
                                   text-gray-600 dark:text-gray-400"
                    >
                      +{songPlaylists.length - 2}
                    </span>
                  )}
                </div>

                {/* MR ë²„íŠ¼ - ë§í¬ ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ */}
                <div className="mt-auto pt-1 pb-2">
                  <button
                    onClick={handlePlay}
                    className="w-full flex items-center justify-center gap-2 px-4 py-2 
                             bg-gradient-to-r from-light-accent to-light-purple 
                             dark:from-dark-accent dark:to-dark-purple text-white 
                             rounded-lg hover:shadow-lg transform hover:scale-105 
                             transition-all duration-200 font-medium"
                  >
                    {youtubeMR ? (
                      <>
                        <ArrowTopRightOnSquareIcon className="w-4 h-4" />
                        <span>MR ì—´ê¸°</span>
                      </>
                    ) : (
                      <>
                        <MagnifyingGlassIcon className="w-4 h-4" />
                        <span>MR ê²€ìƒ‰</span>
                      </>
                    )}
                  </button>
                </div>
              </div>

              {/* Hover effect border */}
              <div
                className="absolute inset-0 rounded-xl border-2 border-transparent 
                              group-hover:border-light-accent/20 dark:group-hover:border-dark-accent/20 
                              transition-colors duration-300 pointer-events-none"
              ></div>
            </>
          ) : (
            /* ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ - ê¸°ì¡´ ë””ìì¸ */
            <>
              {/* Background gradient overlay */}
              <div
                className="absolute inset-0 bg-gradient-to-br from-light-accent/5 to-light-purple/5 
                              dark:from-dark-accent/5 dark:to-dark-purple/5 opacity-0 
                              group-hover:opacity-100 transition-opacity duration-300"
              ></div>

              <div className="relative p-6 bg-white/60 dark:bg-gray-900/60 backdrop-blur-sm h-full">
                {/* Header */}
                <div className="flex items-start justify-between mb-4">
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 flex-wrap mb-2">
                      <h3
                        className="text-lg font-semibold text-light-text dark:text-dark-text 
                                     line-clamp-1 group-hover:text-light-accent dark:group-hover:text-dark-accent 
                                     transition-colors duration-300 flex-1"
                      >
                        {showNumber && number && (
                          <span className="text-light-accent dark:text-dark-accent font-bold mr-2">
                            {number}.
                          </span>
                        )}
                        {displayTitle}
                      </h3>
                      {formatKeyAdjustment(song.keyAdjustment) && (
                        <span
                          className="px-2 py-1 text-xs font-medium rounded-md 
                                       bg-yellow-100 dark:bg-yellow-900 
                                       text-yellow-800 dark:text-yellow-200 flex-shrink-0"
                        >
                          {formatKeyAdjustment(song.keyAdjustment)}
                        </span>
                      )}
                    </div>
                    <p className="text-sm text-light-text/70 dark:text-dark-text/70 mb-3 line-clamp-1">
                      {displayArtist}
                    </p>
                  </div>
                  <div className="flex flex-col gap-2">
                    <button
                      onClick={handleLike}
                      disabled={likeLoading}
                      className="flex items-center justify-center gap-1 px-2 py-1 rounded-full
                                 bg-white/10 dark:bg-gray-800/50 backdrop-blur-sm
                                 hover:bg-light-primary/20 dark:hover:bg-dark-primary/20 
                                 transition-all duration-200 disabled:opacity-50
                                 border border-white/20 dark:border-gray-700/50"
                      title={liked ? "ì¢‹ì•„ìš” ì·¨ì†Œ" : "ì¢‹ì•„ìš”"}
                    >
                      <HeartIcon
                        className={`w-4 h-4 transition-all duration-200 
                                   ${
                                     likeLoading
                                       ? "text-red-400 fill-current opacity-60 animate-pulse scale-110"
                                       : liked
                                       ? "text-red-500 fill-current"
                                       : "text-light-text/60 dark:text-dark-text/60 hover:text-red-400"
                                   }`}
                      />
                      {song.likeCount !== undefined && (
                        <span
                          className={`text-xs font-medium transition-all duration-200 min-w-[1rem] text-center ${
                            liked
                              ? "text-red-500"
                              : "text-light-text/70 dark:text-dark-text/70"
                          }`}
                        >
                          {song.likeCount}
                        </span>
                      )}
                    </button>

                    {/* ë¶€ë¥¸ íšŸìˆ˜ í‘œì‹œ */}
                    {song.sungCount !== undefined && song.sungCount > 0 && (
                      <div
                        className="flex items-center justify-center gap-1 px-2 py-1 rounded-full
                                    bg-green-100/80 dark:bg-green-900/50 
                                    border border-green-200/50 dark:border-green-700/50"
                      >
                        <span className="text-xs font-medium text-green-700 dark:text-green-300">
                          ğŸ¤ {song.sungCount}
                        </span>
                      </div>
                    )}
                  </div>
                </div>

                {/* Language tag and playlist badges */}
                <div className="flex flex-wrap gap-2 mb-2">
                  {song.language && (
                    <span
                      className={`px-2 py-1 rounded-full text-xs font-medium text-white 
                                     ${
                                       languageColors[
                                         song.language as keyof typeof languageColors
                                       ] || "bg-gray-500"
                                     }`}
                    >
                      {song.language}
                    </span>
                  )}
                  {songPlaylists.slice(0, 2).map((playlist) => (
                    <span
                      key={playlist._id}
                      className="px-2 py-1 rounded-full text-xs font-medium
                               bg-purple-100 dark:bg-purple-900 
                               text-purple-800 dark:text-purple-200"
                    >
                      ğŸµ {playlist.name}
                    </span>
                  ))}
                  {songPlaylists.length > 2 && (
                    <span
                      className="px-2 py-1 rounded-full text-xs font-medium
                                   bg-gray-100 dark:bg-gray-800 
                                   text-gray-600 dark:text-gray-400"
                    >
                      +{songPlaylists.length - 2}
                    </span>
                  )}
                </div>

                {/* MR ë²„íŠ¼ - ë§í¬ ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ */}
                <div className="mt-auto pt-1 pb-2">
                  <button
                    onClick={handlePlay}
                    className="w-full flex items-center justify-center gap-2 px-4 py-2 
                             bg-gradient-to-r from-light-accent to-light-purple 
                             dark:from-dark-accent dark:to-dark-purple text-white 
                             rounded-lg hover:shadow-lg transform hover:scale-105 
                             transition-all duration-200 font-medium"
                  >
                    {youtubeMR ? (
                      <>
                        <ArrowTopRightOnSquareIcon className="w-4 h-4" />
                        <span>MR ì—´ê¸°</span>
                      </>
                    ) : (
                      <>
                        <MagnifyingGlassIcon className="w-4 h-4" />
                        <span>MR ê²€ìƒ‰</span>
                      </>
                    )}
                  </button>
                </div>
              </div>

              {/* Hover effect border */}
              <div
                className="absolute inset-0 rounded-xl border-2 border-transparent 
                              group-hover:border-light-accent/20 dark:group-hover:border-dark-accent/20 
                              transition-colors duration-300 pointer-events-none"
              ></div>
            </>
          )}
        </motion.div>
      )}

      {/* í†µí•© MR YouTube í”Œë ˆì´ì–´ - wrapperë¡œ í¬ê¸° ì œí•œ */}
      {isExpanded && youtubeMR && !isEditMode && (
        <div style={optimizedPlayerStyle} className="rounded-lg">
          <YouTube
            key={`unified-mr-${song.id}-${youtubeMR.videoId}`}
            videoId={youtubeMR.videoId}
            opts={{
              width: "100%",
              height: "100%",
              playerVars: {
                autoplay: 0,
                controls: 1,
                rel: 0,
                modestbranding: 1,
                start: youtubeMR.skipSeconds || 0,
                iv_load_policy: 3,
                cc_load_policy: 0,
              },
            }}
            onReady={onYouTubeReady}
            onStateChange={onYouTubeStateChange}
            onPlay={() => setIsPlaying(true)}
            onPause={() => setIsPlaying(false)}
            onEnd={() => setIsPlaying(false)}
            style={{
              width: "100%",
              height: "100%",
            }}
          />
        </div>
      )}

      {/* í†µí•© LiveClip Manager - MR í”Œë ˆì´ì–´ì™€ ë™ì¼í•œ íŒ¨í„´ */}
      {isExpanded && !isEditMode && (
        <div style={optimizedLiveClipStyle} className="rounded-lg">
          <LiveClipManager
            songId={song.id}
            songTitle={displayTitle}
            songVideos={songVideos}
            setSongVideos={setSongVideos}
            videosLoading={videosLoading}
            loadSongVideos={loadSongVideos}
          />
        </div>
      )}

      {/* í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ */}
      <PlaylistContextMenu
        songId={song.id}
        isOpen={showPlaylistMenu}
        position={menuPosition}
        onClose={() => setShowPlaylistMenu(false)}
      />

      {/* ìƒˆë¡œìš´ SongDetailModal */}
      <SongDetailModal
        song={song}
        isExpanded={isExpanded}
        onClose={() => setIsExpanded(false)}
        isMobileScreen={typeof window !== 'undefined' ? window.innerWidth < 1280 : false}
      />
    </>
  );
}
